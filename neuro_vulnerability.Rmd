---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(ggtext)
```

Simulate data

```{r}
set.seed(2022)

df_sim <-
  tibble(
  # Hippocampus
  hippo_1_year  = rbernoulli(1000, p = 0.22),
  hippo_2_year  = rbernoulli(1000, p = 0.25),
  hippo_3_year  = rbernoulli(1000, p = 0.45),
  hippo_4_year  = rbernoulli(1000, p = 0.59),
  hippo_5_year  = rbernoulli(1000, p = 0.48),
  hippo_6_year  = rbernoulli(1000, p = 0.35),
  hippo_7_year  = rbernoulli(1000, p = 0.13),
  hippo_8_year  = rbernoulli(1000, p = 0.05),
  hippo_9_year  = rbernoulli(1000, p = 0.06),
  hippo_10_year = rbernoulli(1000, p = 0.15),
  hippo_11_year = rbernoulli(1000, p = 0.19),
  hippo_12_year = rbernoulli(1000, p = 0.20),
  hippo_13_year = rbernoulli(1000, p = 0.10),
  hippo_14_year = rbernoulli(1000, p = 0.18),
  hippo_15_year = rbernoulli(1000, p = 0.18),
  hippo_16_year = rbernoulli(1000, p = 0.09),
  # Amygdala
  amygd_1_year  = rbernoulli(1000, p = 0.02),
  amygd_2_year  = rbernoulli(1000, p = 0.02),
  amygd_3_year  = rbernoulli(1000, p = 0.02),
  amygd_4_year  = rbernoulli(1000, p = 0.02),
  amygd_5_year  = rbernoulli(1000, p = 0.02),
  amygd_6_year  = rbernoulli(1000, p = 0.04),
  amygd_7_year  = rbernoulli(1000, p = 0.07),
  amygd_8_year  = rbernoulli(1000, p = 0.07),
  amygd_9_year  = rbernoulli(1000, p = 0.07),
  amygd_10_year = rbernoulli(1000, p = 0.59),
  amygd_11_year = rbernoulli(1000, p = 0.49),
  amygd_12_year = rbernoulli(1000, p = 0.19),
  amygd_13_year = rbernoulli(1000, p = 0.18),
  amygd_14_year = rbernoulli(1000, p = 0.13),
  amygd_15_year = rbernoulli(1000, p = 0.09),
  amygd_16_year = rbernoulli(1000, p = 0.02),
  # Prefrontal cortex
  prefr_1_year  = rbernoulli(1000, p = 0.15),
  prefr_2_year  = rbernoulli(1000, p = 0.13),
  prefr_3_year  = rbernoulli(1000, p = 0.14),
  prefr_4_year  = rbernoulli(1000, p = 0.12),
  prefr_5_year  = rbernoulli(1000, p = 0.11),
  prefr_6_year  = rbernoulli(1000, p = 0.11),
  prefr_7_year  = rbernoulli(1000, p = 0.10),
  prefr_8_year  = rbernoulli(1000, p = 0.07),
  prefr_9_year  = rbernoulli(1000, p = 0.16),
  prefr_10_year = rbernoulli(1000, p = 0.14),
  prefr_11_year = rbernoulli(1000, p = 0.08),
  prefr_12_year = rbernoulli(1000, p = 0.16),
  prefr_13_year = rbernoulli(1000, p = 0.16),
  prefr_14_year = rbernoulli(1000, p = 0.59),
  prefr_15_year = rbernoulli(1000, p = 0.44),
  prefr_16_year = rbernoulli(1000, p = 0.49)) %>% 
  pivot_longer(everything(), names_to = "group", values_to = "vulnerability")

```

Fit logistic

```{r}
fit_logit <- glm(vulnerability ~ group,
                 data = df_sim,
                 family = binomial)
```

Emmeans

```{r}
df_emm <-
  emmeans::emmeans(fit_logit, ~group, type = "response") %>% 
  as_tibble() %>% 
  mutate(age = str_extract(group, "\\d+") %>% 
               as.numeric(),
         region = str_extract(group, "^.+(?=_\\d)") %>% 
                  fct_relevel("hippo", "amygd", "prefr")) 
```

Color pallette

```{r}
colors <- c("#0a9396", "#9b2226", "#ee9b00")
```

Labels

```{r}
label_hippo <- "The <span style='color: #0a9396;'>**hippocampus**</span> reaches<br>peak vulnerability ages 3-5"
label_amygd <- "The <span style='color: #9b2226;'>**amygdala**</span><br> at ages 9-11"
label_prefr <- "The <span style='color: #ee9b00;'>**prefrontal cortex**</span><br> after age 12"

label_early  <- "<span style='color: #a5a5a5;'>**Early**<br>**childhood**</span>"
label_middle <- "<span style='color: #a5a5a5;'>**Middle**<br>**childhood**</span>"
label_late   <- "<span style='color: #a5a5a5;'>**Late**<br>**childhood**</span>"
```

Plot

```{r fig.height=5, fig.width=9}
df_emm %>% 
  group_by(region) %>% 
  mutate(max_point = ifelse(prob == max(prob), prob, NA)) %>% 

  ggplot(aes(x = age, y = prob, color = region, fill = region)) +
  geom_point(aes(y = max_point), size = 7, shape = 1, alpha = 1/2) +
  geom_area(alpha = 1/5, color = NA, position = "identity") +
  # Lines
  # geom_line(aes(group = region), size = 1, alpha = 1/5) +
  geom_vline(xintercept = 8, size = 1, linetype = 2, color = "grey", alpha = 1/2) +
  geom_vline(xintercept = 12, size = 1, linetype = 2, color = "grey", alpha = 1/2) +
  # Labels brain regions
  annotate(geom = "richtext", x= 4, y = .66, label = label_hippo,
           fill = NA, label.color = NA, size = 3.5) +
  annotate(geom = "richtext", x= 10, y = .66, label = label_amygd,
           fill = NA, label.color = NA, size = 3.5) +
  annotate(geom = "richtext", x= 14, y = .66, label = label_prefr,
           fill = NA, label.color = NA, size = 3.5) +
  # Labels age periods
  annotate(geom = "richtext", x= 4, y = .77, label = label_early,
           fill = NA, label.color = NA, size = 4.5) +
  annotate(geom = "richtext", x= 10, y = .77, label = label_middle,
           fill = NA, label.color = NA, size = 4.5) +
  annotate(geom = "richtext", x= 14, y = .77, label = label_late,
           fill = NA, label.color = NA, size = 4.5) +
  # Scales
  scale_x_continuous(breaks = 0:16, expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 0.82), expand = c(0, 0)) +
  scale_color_manual(values = colors) +
  scale_fill_manual(values = colors) +
  labs(x = "Age of exposure to stress", y = "Vulnerability to stress") +
  theme_minimal() +
  theme(legend.position = "none",
        axis.line   = element_line(color = "#ced4da"),
        axis.text   = element_text(color = "#6c757d"),
        axis.title  = element_text(color = "#6c757d"),
        axis.text.y = element_blank(),
        axis.ticks  = element_blank(), 
        panel.grid = element_blank())
```

Export

```{r}
ggsave("plots/neuro_vulnerability.png", bg = "white", height=5, width=9)
```